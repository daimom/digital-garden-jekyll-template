---
aliases : 
tags: #ğŸŒ
up: [[0.Network MOC -Troubleshooting]]
same: 
down:
next:
prev:
---

# ç¡ç¡å¿µ

å‰äººå¾ˆå¼·ï¼Œå¾ˆå²å®³ï¼Œå–œæ­¡è‡ªå·±å‹•æ‰‹ï¼Œ
æ‰€ä»¥ä»–ç•¶åˆé€ çš„è‡ªå‹•å–å¾—Let's Encryptçš„ç¨‹å¼ï¼Œéƒ½æ˜¯è‡ªå·±å¯«ä¸€æ•´å¥—ä¾†ç”¨ã€‚
ç„¶å¾Œï¼Œäº¤æ¥äº†æ•´å¥—ï¼Œä½†ç¨‹å¼æ²’äººçŸ¥é“åœ¨å¹¹å˜›ï¼Œåªæœ‰æ¯æ¬¡å‡ºå•é¡Œæ™‚ï¼Œ
æœƒå»ç¿»APIçœ‹æ˜¯è¦å…ˆcallå“ªå€‹ï¼Œå†callå“ªå€‹ï¼Œç„¶å¾Œå†é‡é–‹æŸäº›image
æ‰èƒ½æ­£ç¢ºå–å¾—ï¼Œèº«çˆ²ä¸€å€‹æ‡¶äººï¼Œè·Ÿè…¦ç´°èƒå®¹é‡éå°çš„æˆ‘ï¼Œå¯¦åœ¨è¨˜ä¸ä½é˜¿ï¼Œ
åªå¥½æ”¹äº†ã€‚

# æ­£æ–‡

## é€™å€‹åªé©åˆDockerï¼Œk8sè«‹æ”¹ç”¨cert-manage

ä½¿ç”¨èªªæ˜

æˆ‘é€™é‚Šæ˜¯æ›è¼‰user_conf.d åˆ° /etc/nginx/user_conf.d ï¼Œ
user_conf.då°±æ˜¯è¨­å®šæª”å­˜æ”¾çš„ä½ç½®ã€‚

docker-compose.yaml
```
version: '3'

services:
  nginx:
    image: jonasal/nginx-certbot:latest
    container_name: nginx
    restart: unless-stopped
    networks:
      - cicd_net
    env_file:
      - ./nginx-certbot.env
    ports:
      - 80:80
      - 443:443
    volumes:
      - nginx_secrets:/etc/letsencrypt
      - ./user_conf.d:/etc/nginx/user_conf.d

volumes:
  nginx_secrets:

# è·Ÿdrone servereæ›åœ¨åŒä¸€å±¤
networks:
  cicd_net:
    name: cicd_net
    driver: bridge  

```

è¨˜å¾—æ›´æ”¹emailï¼Œä¸ç„¶å•“å‹•æœƒå¤±æ•—
nginx-certbot.env
```
# Required
CERTBOT_EMAIL=<email>

# Optional (Defaults)
DHPARAM_SIZE=2048
ELLIPTIC_CURVE=secp256r1
RENEWAL_INTERVAL=8d
RSA_KEY_SIZE=2048
STAGING=0
USE_ECDSA=1

# Advanced (Defaults)
CERTBOT_AUTHENTICATOR=webroot
CERTBOT_DNS_PROPAGATION_SECONDS=""
DEBUG=0
USE_LOCAL_CA=0

```


user_conf.dè³‡æ–™å¤¾å…§çš„æª”æ¡ˆåç¨±
```
server {
    # Listen to port 443 on both IPv4 and IPv6.
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Domain names this server should respond to.
    server_name otpat.domain.com;

    # Load the certificate files.
    ssl_certificate         /etc/letsencrypt/live/otpat-domain-com/fullchain.pem;
    ssl_certificate_key     /etc/letsencrypt/live/otpat-domain-com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/otpat-domain-com/chain.pem;

    ssl_protocols             TLSv1.3 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ecdh_curve            X25519:secp521r1:secp384r1;
    ssl_ciphers               TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_session_cache         shared:TLS:2m;
    ssl_buffer_size           4k;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 1.1.1.1 1.0.0.1 [2606:4700:4700::1111] [2606:4700:4700::1001]; # Cloudflare

   # return 200 'Let\'s Encrypt certificate successfully installed!';
   # add_header Content-Type text/plain;

   location / {
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;

        proxy_pass http://totp-auth:9987;

        proxy_redirect off;
        proxy_http_version 1.1;
        proxy_buffering off;

        chunked_transfer_encoding off;
    }

}

```

å®Œæˆå“ï¼Œå› ç‚ºè¦å°‡proxy_passå°åˆ°æœå‹™ä¸Šé¢ï¼Œæœ€å¥½æ˜¯è¨­æˆåŒä¸€å€‹networkï¼Œé€™é‚Šè¨­ç‚º cicd_net
![[157-fig.1.jpg]]



å¦‚æœå•“å‹•å¤±æ•—çš„è©±ï¼Œ
å¯ä»¥æŸ¥ä¸€ä¸‹nginxè£é¢çš„éŒ¯èª¤è¨Šæ¯ï¼Œä¸Šé¢é€šå¸¸å¯«çš„å¾ˆæ¸…æ¥šã€‚

å»ºè­°å¯ä»¥å…ˆçœ‹çœ‹é€™å…©ç¯‡
ref. 
	- [D15 - NGINX-Certbot Image](https://ithelp.ithome.com.tw/articles/10301801)
	- [github_good_to_know](https://github.com/JonasAlfredsson/docker-nginx-certbot/blob/master/docs/good_to_know.md)